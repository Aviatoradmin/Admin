<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Game</title>
    <style>
        /* --- General & Mobile Reset --- */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Global Containers --- */
        #app-container {
            width: 100%;
            max-width: 450px; /* Typical phone width */
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #000; /* Main game page color */
            position: relative;
        }
        
        /* --- A. Login/Registration Styles --- */
        #auth-screen {
            background-color: #1a1a40; /* Blue login page color */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .auth-box {
            background-color: #2c2c54;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
            margin-bottom: 15px;
            text-align: center;
        }
        .auth-box h2 {
            margin-top: 0;
            color: #fff;
        }
        .auth-input-group {
            margin-bottom: 15px;
            text-align: left;
            position: relative;
        }
        .auth-input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .auth-input-group input {
            width: calc(100% - 20px);
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4f4f7a;
            color: #fff;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #ccc;
            user-select: none;
        }
        .auth-button, .main-auth-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .main-auth-button {
            background-color: #ffd700; /* Yellow */
            color: #000;
            margin-bottom: 20px;
        }
        .auth-button-green {
            background-color: #4CAF50; /* Green */
            color: #fff;
        }
        .auth-button-red {
            background-color: #f44336; /* Red */
            color: #fff;
        }
        #error-message {
            color: #f44336;
            margin-top: 10px;
            font-weight: bold;
        }

        /* --- B. Game Body Styles --- */
        #game-screen {
            display: none; /* Hidden by default */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 5px;
            box-sizing: border-box;
            background-color: #000;
        }

        /* --- B.i. Top Bar (Withdraw & Balance) --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            gap: 5px;
        }
        .top-bar-box {
            padding: 10px;
            border-radius: 8px;
            flex: 1;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            position: relative; /* For the proceed box */
            overflow: hidden;
        }
        #withdraw-bar {
            background-color: #ffd700; /* Yellow */
            color: #000;
        }
        #balance-bar {
            background-color: #4CAF50; /* Green */
            color: #fff;
        }
        #balance-bar span {
            font-size: 1.2em;
        }

        .withdraw-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #withdraw-amount-input {
            width: calc(100% - 10px);
            padding: 5px;
            border: none;
            border-radius: 5px;
            background-color: #fff;
            color: #000;
        }
        #withdraw-proceed-btn {
            background-color: #007bff; /* Blue */
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .submitted-msg {
            color: #007bff;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* --- B.i. Aviator Plane Box --- */
        #aviator-plane-box {
            flex-grow: 1;
            background-color: #1a1a1a;
            border-radius: 8px;
            margin-bottom: 5px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #live-multiplier {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #ffd700;
            display: none; /* Shown when round is active */
            z-index: 10;
        }
        #plane-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #countdown-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: #f44336;
            text-shadow: 0 0 10px #f44336;
            display: block; /* Shown during 5s wait */
            z-index: 10;
        }


        /* --- B.vii. Past Multipliers --- */
        #past-multipliers-bar {
            width: 100%;
            background-color: #1a1a1a;
            padding: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: flex-start;
            gap: 5px;
            overflow-x: auto;
            white-space: nowrap;
            margin-bottom: 5px;
        }
        .multiplier-item {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        .m-low { background-color: #007bff; } /* Blue for low */
        .m-high { background-color: #ffd700; color: #000; } /* Yellow for high */

        /* --- B.vi & B.vii. Bottom Bar (Stake & Bet/Cashout) --- */
        .bottom-bar {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            height: 70px;
        }
        .bottom-bar-box {
            padding: 10px;
            border-radius: 8px;
            flex: 1;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Stake Box */
        #stake-box {
            background-color: #007bff; /* Blue */
            color: #fff;
        }
        #stake-amount-input {
            width: calc(100% - 10px);
            padding: 5px;
            margin-top: 5px;
            border: none;
            border-radius: 5px;
            background-color: #fff;
            color: #000;
            text-align: center;
            font-weight: bold;
        }
        .stake-label {
            font-size: 0.8em;
        }

        /* Bet/Cashout Box */
        #bet-cashout-box {
            background-color: #4CAF50; /* Default Green for Bet */
            color: #fff;
            justify-content: space-between;
        }
        .bet-status {
            font-size: 1.2em;
            text-transform: uppercase;
        }
        .bet-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* State Modifiers */
        .state-cashout {
            background-color: #ffd700 !important; /* Yellow */
            color: #000 !important;
        }
        .state-cancel {
            background-color: #f44336 !important; /* Red */
            color: #fff !important;
        }
        
    </style>
</head>
<body>

<div id="app-container">
    <div id="auth-screen">
        <h1 style="color: #ffd700;">Aviator</h1>
        <div id="initial-auth-box" class="auth-box">
            <h2>Welcome</h2>
            <button class="main-auth-button" onclick="showCreateAccount()">CREATE ACCOUNT</button>
            <button class="main-auth-button" onclick="showLogin()">LOG IN</button>
        </div>

        <div id="create-account-box" class="auth-box" style="display: none;">
            <h2>Create Account</h2>
            <div class="auth-input-group">
                <label for="reg-phone">Phone Number</label>
                <input type="tel" id="reg-phone" placeholder="Enter phone number">
            </div>
            <div class="auth-input-group">
                <label for="reg-password">Password</label>
                <input type="password" id="reg-password" placeholder="Enter password">
                <span class="password-toggle" onclick="togglePasswordVisibility('reg-password')">üëÅÔ∏è</span>
            </div>
            <div class="auth-input-group">
                <label for="reg-confirm-password">Confirm Password</label>
                <input type="password" id="reg-confirm-password" placeholder="Confirm password">
                <span class="password-toggle" onclick="togglePasswordVisibility('reg-confirm-password')">üëÅÔ∏è</span>
            </div>
            <div style="font-size: 0.8em; margin-bottom: 15px;">
                <input type="checkbox" id="save-password-reg">
                <label for="save-password-reg">Save Password to browser (optional)</label>
            </div>
            <button class="auth-button auth-button-green" onclick="createAccount()">CREATE ACCOUNT</button>
            <p id="reg-error-message" style="color: #f44336; font-weight: bold;"></p>
        </div>

        <div id="login-box" class="auth-box" style="display: none;">
            <h2>Log In</h2>
            <div class="auth-input-group">
                <label for="login-phone">Phone Number</label>
                <input type="tel" id="login-phone" placeholder="Enter phone number">
            </div>
            <div class="auth-input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter password">
                <span class="password-toggle" onclick="togglePasswordVisibility('login-password')">üëÅÔ∏è</span>
            </div>
            <div style="font-size: 0.8em; margin-bottom: 15px;">
                <input type="checkbox" id="save-password-login">
                <label for="save-password-login">Save Password to browser (optional)</label>
            </div>
            <button class="auth-button auth-button-green" onclick="login()">LOG IN</button>
            <p id="login-error-message" style="color: #f44336; font-weight: bold;"></p>
        </div>
    </div>

    <div id="game-screen">
        
        <div class="top-bar">
            <div id="withdraw-bar" class="top-bar-box" onclick="toggleWithdraw()">
                <div id="withdraw-display">WITHDRAW</div>
                <div id="withdraw-input" class="withdraw-input-group" style="display: none;">
                    <input type="number" id="withdraw-amount-input" placeholder="Enter Amount" min="1">
                    <div id="withdraw-proceed-btn" onclick="processWithdraw(event)">PROCEED</div>
                    <div id="withdraw-status" class="submitted-msg" style="display: none;"></div>
                </div>
            </div>
            <div id="balance-bar" class="top-bar-box">
                BALANCE: <span id="current-balance">1000</span>
            </div>
        </div>

        <div id="aviator-plane-box">
            <canvas id="plane-canvas"></canvas>
            <div id="live-multiplier" style="display: none;">X1.00</div>
            <div id="countdown-timer" style="display: none;">5</div>
        </div>

        <div id="past-multipliers-bar">
            </div>

        <div class="bottom-bar">
            <div id="stake-box" class="bottom-bar-box">
                <div class="stake-label">STAKE</div>
                <input type="number" id="stake-amount-input" value="10" min="1" oninput="updateBetValue()">
            </div>
            
            <div id="bet-cashout-box" class="bottom-bar-box" onclick="handleBetCashOut()">
                <div class="bet-status" id="bet-status">BET</div>
                <div class="bet-value" id="bet-value">10</div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Global State Variables ---
    let currentUser = null;
    let balance = 1000;
    let currentStake = 10;
    let betPlaced = false;
    let isCashedOut = false;
    let roundActive = false;
    let countdownActive = false;
    let roundStartTime = 0;
    let generatedMultiplier = 0;
    let animationFrameId = null;
    let countdownIntervalId = null;
    let pastMultipliers = [];

    // --- DOM Elements ---
    const appContainer = document.getElementById('app-container');
    const authScreen = document.getElementById('auth-screen');
    const gameScreen = document.getElementById('game-screen');
    const balanceDisplay = document.getElementById('current-balance');
    const stakeInput = document.getElementById('stake-amount-input');
    const betCashoutBox = document.getElementById('bet-cashout-box');
    const betStatusElement = document.getElementById('bet-status');
    const betValueElement = document.getElementById('bet-value');
    const liveMultiplierElement = document.getElementById('live-multiplier');
    const countdownTimerElement = document.getElementById('countdown-timer');
    const pastMultipliersBar = document.getElementById('past-multipliers-bar');
    const withdrawDisplay = document.getElementById('withdraw-display');
    const withdrawInput = document.getElementById('withdraw-input');
    const withdrawAmountInput = document.getElementById('withdraw-amount-input');
    const withdrawStatus = document.getElementById('withdraw-status');

    // --- A. Authentication Logic ---

    const getUsers = () => JSON.parse(localStorage.getItem('aviatorUsers')) || {};
    const saveUsers = (users) => localStorage.setItem('aviatorUsers', JSON.stringify(users));

    const togglePasswordVisibility = (id) => {
        const input = document.getElementById(id);
        const icon = input.nextElementSibling;
        if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'üîí';
        } else {
            input.type = 'password';
            icon.textContent = 'üëÅÔ∏è';
        }
    };

    const showCreateAccount = () => {
        document.getElementById('initial-auth-box').style.display = 'none';
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('create-account-box').style.display = 'flex';
        document.getElementById('reg-error-message').textContent = '';
    };

    const showLogin = () => {
        document.getElementById('initial-auth-box').style.display = 'none';
        document.getElementById('create-account-box').style.display = 'none';
        document.getElementById('login-box').style.display = 'flex';
        document.getElementById('login-error-message').textContent = '';
    };

    const createAccount = () => {
        const phone = document.getElementById('reg-phone').value;
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const errorMessage = document.getElementById('reg-error-message');

        if (!phone || !password || !confirmPassword) {
            errorMessage.textContent = 'All fields are required.';
            return;
        }
        if (password !== confirmPassword) {
            errorMessage.textContent = 'Passwords do not match.';
            return;
        }

        const users = getUsers();
        if (users[phone]) {
            errorMessage.textContent = 'Account with this phone number already exists.';
            return;
        }

        users[phone] = { password: password, balance: 1000 };
        saveUsers(users);

        currentUser = phone;
        balance = 1000;
        loginSuccess();
    };

    const login = () => {
        const phone = document.getElementById('login-phone').value;
        const password = document.getElementById('login-password').value;
        const errorMessage = document.getElementById('login-error-message');
        const users = getUsers();

        if (users[phone] && users[phone].password === password) {
            currentUser = phone;
            balance = users[phone].balance;
            loginSuccess();
        } else {
            errorMessage.textContent = 'Invalid phone number or password.';
        }
    };

    const loginSuccess = () => {
        authScreen.style.display = 'none';
        gameScreen.style.display = 'flex';
        updateBalanceDisplay();
        updateBetValue();
        startGameLoop(); // Start the game loop (countdown or active round)
    };

    const logout = () => {
        // Save current balance before logging out
        if (currentUser) {
            const users = getUsers();
            users[currentUser].balance = balance;
            saveUsers(users);
        }
        
        currentUser = null;
        gameScreen.style.display = 'none';
        authScreen.style.display = 'flex';
        document.getElementById('create-account-box').style.display = 'none';
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('initial-auth-box').style.display = 'flex';
        
        // Stop game loop/animation
        stopGameLoop(); 
    };
    
    // Check if user is logged in on load or focus
    window.onload = () => {
        // Simple check to see if a session existed previously (e.g., from a save-password check)
        const savedUser = localStorage.getItem('lastLoggedInUser');
        if (savedUser) {
            // Force a re-login check as per the NOTE, only showing the login box
            showLogin();
            document.getElementById('initial-auth-box').style.display = 'none';
        }
    };
    
    // NOTE: This is the logic to re-login if user navigates away and comes back (simulate visit other links/apps)
    window.onfocus = () => {
        if (currentUser && gameScreen.style.display === 'flex') {
            // If user was logged in and game is visible, assume continuous play
            return;
        } else if (currentUser && gameScreen.style.display === 'none') {
            // User was logged in but game screen is hidden (e.g., they logged out, or screen was hidden by other activity)
            // Forcing re-login here, assuming the 'visit other apps/links' means a re-auth is needed.
            if (confirm("Session expired. Please log in again.")) {
                logout();
            }
        }
    };

    // --- B. Game Logic and UI Updates ---

    const updateBalanceDisplay = () => {
        balanceDisplay.textContent = balance.toFixed(2);
    };

    const updateBetValue = () => {
        let amount = parseFloat(stakeInput.value);
        if (isNaN(amount) || amount <= 0) {
            amount = 1;
            stakeInput.value = 1;
        }
        currentStake = amount;
        
        if (!betPlaced) {
            betValueElement.textContent = currentStake.toFixed(2);
        }
    };
    
    const updatePastMultipliersBar = (multiplier) => {
        pastMultipliers.unshift(multiplier);
        if (pastMultipliers.length > 10) pastMultipliers.pop();
        
        pastMultipliersBar.innerHTML = '';
        pastMultipliers.forEach(m => {
            const item = document.createElement('span');
            item.className = 'multiplier-item ' + (m >= 2.0 ? 'm-high' : 'm-low');
            item.textContent = m.toFixed(2) + 'x';
            pastMultipliersBar.appendChild(item);
        });
    };

    const handleBetCashOut = () => {
        if (roundActive && betPlaced && !isCashedOut) {
            // --- CASH OUT ---
            const currentMultiplier = calculateLiveMultiplier(Date.now());
            const winnings = currentStake * currentMultiplier;
            balance += winnings;
            isCashedOut = true;
            betPlaced = false;
            updateBalanceDisplay();
            
            // UI Update
            betCashoutBox.classList.remove('state-cashout');
            betStatusElement.textContent = 'CASHED OUT';
            betValueElement.textContent = winnings.toFixed(2);

            // Save balance to storage immediately
            const users = getUsers();
            users[currentUser].balance = balance;
            saveUsers(users);

            // The button will reset to 'BET' state at the start of the next 5s countdown
            
        } else if (betPlaced && (countdownActive || roundActive)) {
            // --- CANCEL (Only possible if round hasn't started its flight) ---
            if (countdownActive) {
                betPlaced = false;
                betCashoutBox.classList.remove('state-cancel');
                betStatusElement.textContent = 'BET';
                betValueElement.textContent = currentStake.toFixed(2);
            }
            // Cannot cancel if the plane is flying (roundActive=true), even if missed the round
            
        } else if (!betPlaced && !roundActive) {
            // --- PLACE BET during 5s countdown ---
            if (currentStake > balance) {
                alert("Stake amount exceeds balance!");
                return;
            }
            betPlaced = true;
            isCashedOut = false;
            
            // UI Update for Cancel/Waiting for next round
            betCashoutBox.classList.add('state-cancel');
            betStatusElement.textContent = 'CANCEL';
            betValueElement.innerHTML = `WAITING FOR NEXT ROUND`;
            
        } else if (!betPlaced && roundActive) {
            // --- PLACE BET during ongoing round (means bet for NEXT round) ---
            if (currentStake > balance) {
                alert("Stake amount exceeds balance!");
                return;
            }
            betPlaced = true;
            isCashedOut = false;
            
            // UI Update for Cancel/Waiting for next round
            betCashoutBox.classList.add('state-cancel');
            betStatusElement.textContent = 'CANCEL';
            betValueElement.innerHTML = `WAITING FOR NEXT ROUND`;
        }
    };
    
    // --- C. Multiplier Generation ---
    
    // Pseudo-Random Number Generator (PRNG) for a deterministic sequence
    // This allows all clients with the same seed (date) to see the same burst
    const prng = (seed) => {
        let x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
    };

    const generateNextMultiplier = () => {
        // Seed based on current UTC date for daily consistency
        const now = new Date();
        const seed = now.getUTCDate() + now.getUTCMonth() * 31 + now.getUTCFullYear() * 365;
        
        // This is a highly simplified way to make a multiplier > 1.0
        // The prng function needs to be a robust one for a crash game.
        // For demo: Use the prng to get a value, and map it to a crash curve.
        
        // A common formula for crash games: H / (H - R) where R is a random number and H is the house edge (e.g., 100)
        // Since we are not simulating R and H, let's just map the PRNG result.
        
        const randomValue = prng(seed + pastMultipliers.length); // Use a unique value for each round
        let multiplier = 1 / (1 - randomValue) * 0.95; // 0.95 is a simplified "house edge"
        
        // Clamp it to a minimum just in case of PRNG edge cases
        return Math.max(1.01, multiplier); 
    };

    const calculateLiveMultiplier = (time) => {
        const elapsed = (time - roundStartTime) / 1000; // time in seconds
        
        // Simplified exponential growth for multiplier: M = 1 + elapsed * rate
        // A more realistic curve is M = 1.00 + (A * e^(B*t) - A)
        
        const A = 1.0; 
        const B = 0.5;
        let M = A * Math.exp(B * elapsed);
        
        return Math.min(M, generatedMultiplier);
    };


    // --- C. Animation Logic (Canvas) ---
    const canvas = document.getElementById('plane-canvas');
    const ctx = canvas.getContext('2d');
    const planeImg = new Image();
    // In a real project, this should be a proper image URL
    // For this single HTML file, let's use a simple triangle or circle to represent the plane
    
    let planeX = 0;
    let planeY = 0;

    const drawPlane = (x, y, multiplier) => {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Redraw grid/axis lines if desired (omitted for simplicity)
        
        // Plane Path: Move from bottom-left towards top-right in an asymptotic curve
        // Start: (0, height)
        // End: (width, 0) - or near it

        // 1. Draw Path (Simplified line for clarity)
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        
        // Draw the path to the current plane position
        // The x-position should map time (t) and the y-position should map the multiplier (M)
        
        // Use the current multiplier to set the plane position
        const maxM = generatedMultiplier;
        const M = multiplier;
        
        // Simplified mapping for x and y
        // x: maps M from 1.0 to maxM across canvas width
        // y: maps M from 1.0 to maxM across canvas height (inverted)
        
        // Mapped X position (asymptotic growth, less time for higher M)
        let normalizedM = (M - 1) / (maxM - 1);
        normalizedM = Math.max(0, normalizedM); // Should not be less than 0
        
        // Simplified X mapping: Starts slow, gets faster (exponential-like)
        planeX = canvas.width * (1 - Math.exp(-normalizedM * 2)); // Use an exponential-like curve for X
        planeX = Math.min(planeX, canvas.width * 0.9); // Limit X for safety
        
        // Simplified Y mapping: Starts at bottom (height), moves to top (0)
        planeY = canvas.height * (1 - normalizedM * 0.9) + (canvas.height * 0.1); 
        planeY = Math.max(planeY, canvas.height * 0.1); // Limit Y for safety

        // Late-Stage Movement (Exponential Decay Oscillation)
        if (M / maxM > 0.75 && M < maxM) {
            const decayFactor = Math.exp(-0.5 * (M / maxM) * 10);
            const oscillation = 10 * Math.sin((M - 1) * 20) * decayFactor;
            planeY += oscillation;
        }

        ctx.lineTo(planeX, planeY);
        ctx.stroke();

        // 2. Draw Plane (Simple circle/triangle for demo)
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(planeX, planeY, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // 3. Draw Multiplier Text on Canvas (next to plane)
        ctx.font = "18px Arial";
        ctx.fillStyle = '#ffd700';
        ctx.fillText(`x${multiplier.toFixed(2)}`, planeX + 15, planeY - 10);
    };

    // --- Game Round Management ---

    const startCountdown = () => {
        liveMultiplierElement.style.display = 'none';
        countdownTimerElement.style.display = 'block';
        let countdown = 5;
        countdownTimerElement.textContent = countdown;
        countdownActive = true;
        roundActive = false;

        betCashoutBox.classList.remove('state-cashout', 'state-cancel');
        betCashoutBox.style.backgroundColor = '#4CAF50';
        betCashoutBox.style.color = '#fff';
        betStatusElement.textContent = 'BET';
        betValueElement.textContent = currentStake.toFixed(2);
        
        // Handle a successful bet that was 'Waiting for next round'
        if (betPlaced && !isCashedOut) {
             betCashoutBox.classList.add('state-cancel');
             betStatusElement.textContent = 'CANCEL';
             betValueElement.innerHTML = `WAITING FOR NEXT ROUND`;
        }

        countdownIntervalId = setInterval(() => {
            countdown--;
            countdownTimerElement.textContent = countdown;

            if (countdown <= 0) {
                clearInterval(countdownIntervalId);
                startRound();
            }
        }, 1000);
    };

    const startRound = () => {
        generatedMultiplier = generateNextMultiplier();
        roundStartTime = Date.now();
        roundActive = true;
        countdownActive = false;
        countdownTimerElement.style.display = 'none';
        liveMultiplierElement.style.display = 'block';
        
        // Finalize any bet that was 'Waiting for next round'
        if (betPlaced && !isCashedOut) {
            // DEDUCT STAKE and transition to Cash Out state
            if (currentStake <= balance) {
                balance -= currentStake;
                updateBalanceDisplay();
                
                betCashoutBox.classList.remove('state-cancel');
                betCashoutBox.classList.add('state-cashout');
                betStatusElement.textContent = 'CASH OUT';
                
            } else {
                // Not enough balance, cancel the bet silently
                betPlaced = false;
                alert("Insufficient balance for the bet. Bet cancelled.");
                betCashoutBox.classList.remove('state-cancel');
                betStatusElement.textContent = 'BET';
                betValueElement.textContent = currentStake.toFixed(2);
            }
        } else {
             // Bet was not placed or was cashed out/cancelled, reset to default BET
             betPlaced = false;
             betCashoutBox.classList.remove('state-cashout', 'state-cancel');
             betCashoutBox.style.backgroundColor = '#4CAF50';
             betCashoutBox.style.color = '#fff';
             betStatusElement.textContent = 'BET';
             betValueElement.textContent = currentStake.toFixed(2);
        }

        requestAnimationFrame(gameLoop);
    };

    const endRound = (bustedMultiplier) => {
        cancelAnimationFrame(animationFrameId);
        roundActive = false;
        liveMultiplierElement.style.display = 'none';
        
        updatePastMultipliersBar(bustedMultiplier);

        if (betPlaced && !isCashedOut) {
            // Player lost the stake (already deducted)
            betStatusElement.textContent = 'LOST';
            betValueElement.textContent = `x${bustedMultiplier.toFixed(2)}`;
            // The button resets to BET state in the startCountdown function
        }
        
        betPlaced = false;
        isCashedOut = false; // Reset for next round

        // Wait 5 seconds for the next round
        setTimeout(startCountdown, 5000);
    };

    const gameLoop = (timestamp) => {
        if (!roundActive) return;

        const currentMultiplier = calculateLiveMultiplier(Date.now());
        
        // --- BURST CHECK ---
        if (currentMultiplier >= generatedMultiplier) {
            liveMultiplierElement.textContent = `x${generatedMultiplier.toFixed(2)}`;
            endRound(generatedMultiplier);
            return;
        }

        // --- UPDATE UI & ANIMATION ---
        liveMultiplierElement.textContent = `x${currentMultiplier.toFixed(2)}`;
        
        if (betPlaced && !isCashedOut) {
            // Update real-time winnings in Cash Out button
            const winnings = currentStake * currentMultiplier;
            betValueElement.textContent = winnings.toFixed(2);
        }
        
        // Draw the plane on the canvas
        drawPlane(0, 0, currentMultiplier);

        animationFrameId = requestAnimationFrame(gameLoop);
    };

    const startGameLoop = () => {
        // Initialize canvas size
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        
        // Start the first countdown
        startCountdown();
    };
    
    const stopGameLoop = () => {
        clearInterval(countdownIntervalId);
        cancelAnimationFrame(animationFrameId);
    };

    // --- Withdrawal Logic ---
    const toggleWithdraw = () => {
        withdrawDisplay.style.display = withdrawDisplay.style.display === 'none' ? 'block' : 'none';
        withdrawInput.style.display = withdrawInput.style.display === 'flex' ? 'none' : 'flex';
        withdrawStatus.style.display = 'none';
        withdrawAmountInput.value = '';
        if (withdrawDisplay.style.display === 'none') {
            withdrawAmountInput.focus();
        }
    };
    
    const processWithdraw = (event) => {
        event.stopPropagation(); // Prevents the parent 'toggleWithdraw' from running
        
        const amount = parseFloat(withdrawAmountInput.value);
        if (isNaN(amount) || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }
        
        if (amount > balance) {
            alert("Amount exceeds current balance.");
            return;
        }
        
        // Deduct from balance
        balance -= amount;
        updateBalanceDisplay();
        
        // Update storage
        const users = getUsers();
        users[currentUser].balance = balance;
        saveUsers(users);
        
        // Display SUBMITTED message
        withdrawStatus.textContent = 'SUBMITTED';
        withdrawStatus.style.display = 'block';
        withdrawAmountInput.style.display = 'none';
        document.getElementById('withdraw-proceed-btn').style.display = 'none';

        // Revert to normal Withdraw bar after a short delay
        setTimeout(() => {
            document.getElementById('withdraw-proceed-btn').style.display = 'block';
            withdrawAmountInput.style.display = 'block';
            toggleWithdraw();
        }, 2000); 
    };
    
    // --- Initial Setup on Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // If a user is not logged in, show initial auth options
        if (!currentUser) {
            authScreen.style.display = 'flex';
            gameScreen.style.display = 'none';
        }
        
        // Ensure initial UI state is correct
        updateBetValue();
    });

</script>

</body>
  </html>
