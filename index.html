<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Demo</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#111;
    --accent:#00b04f;
    --muted:#888;
    --yellow:#f0c000;
    --red:#d9534f;
  }
  body{margin:0;font-family:sans-serif;background:var(--bg);color:#fff}
  #app{display:none;flex-direction:column;align-items:center;justify-content:flex-start;height:100vh;padding:12px;box-sizing:border-box;}
  .header,.controls{width:100%;max-width:480px;margin-bottom:12px;}
  .header div,.controls div{margin-bottom:6px;}
  .big-left,.big-right{flex:1;display:flex;flex-direction:column;}
  .stake-box input{width:100%;padding:6px;}
  .deposit-btn{background:var(--accent);color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;}
  .bet-button{padding:6px 12px;border-radius:4px;cursor:pointer;text-align:center;}
  .bet-button.bet{background:var(--accent);}
  .bet-button.cancel{background:var(--red);}
  .bet-button.yellow{background:var(--yellow);}
  .past-item{font-size:13px;color:var(--muted);}
  .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;}
  .card{background:var(--panel);padding:12px;border-radius:8px;width:320px;max-width:90%;}
  .form-row{margin-bottom:8px;}
  .row-h{display:flex;gap:8px;}
  input{width:100%;padding:6px;border-radius:4px;border:none;}
  .linkish{color:var(--yellow);cursor:pointer;font-size:12px;}
  .footer-note{text-align:center;font-size:12px;margin-top:12px;color:var(--muted);}
</style>
</head>
<body>
<div id="loading">Loading...</div>
<div id="app">
  <div class="header">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>Balance: <span id="balanceBox">1000</span></div>
      <div>
        <span id="sessionName" style="display:none">Hi, <span id="userNameTxt"></span></span>
        <button id="loginBtn" class="deposit-btn">Login</button>
        <button id="logoutBtn" class="deposit-btn" style="display:none">Logout</button>
      </div>
    </div>
    <div style="font-size:13px;color:var(--muted)">Past 10 multipliers</div>
    <div style="font-size:13px;color:var(--muted)">Round time: <span id="roundTimer">--</span></div>
    <div class="past-list" id="pastList" style="margin-top:6px"></div>
  </div>

  <section class="controls">
    <div class="big-left">
      <div class="stake-box">
        <div style="font-size:13px;color:var(--muted)">Stake</div>
        <input id="stakeInput" type="number" placeholder="Enter stake amount" min="1" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="maxBtn" class="deposit-btn">Max</button>
          <button id="plus10" class="deposit-btn">+10</button>
          <button id="plus50" class="deposit-btn">+50</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="bet-box" style="flex:1">
          <div style="font-size:12px;color:var(--muted)">Bet</div>
          <div id="betAmount" style="font-weight:800;font-size:18px">0</div>
        </div>
        <div id="betButton" class="bet-button bet" style="width:150px;display:flex;align-items:center;justify-content:center">Bet</div>
      </div>
    </div>

    <div class="big-right">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="font-size:13px;color:var(--muted)">Deposit</div>
        <div class="deposit-btn" id="depositBtn">Deposit</div>
      </div>
      <div style="margin-top:8px">
        <div style="font-size:13px;color:var(--muted)">Status</div>
        <div id="statusBox" style="background:#07121a;padding:8px;border-radius:8px;margin-top:6px">Idle</div>
      </div>
    </div>
  </section>

  <div id="roundStateMsg" style="margin-bottom:6px;font-size:14px"></div>

  <div class="footer-note">We keep your data secure and confidential. (Win_Big)</div>
</div>

<!-- Login / register overlay -->
<div id="authOverlay" class="overlay" style="display:none">
  <div class="card">
    <div class="top-controls">
      <strong id="authTitle">Login</strong>
      <div><button id="closeAuth" class="linkish">Close</button></div>
    </div>

    <div id="loginForm">
      <div class="form-row">
        <label>Phone number</label>
        <input id="loginPhone" placeholder="07XXXXXXXX" />
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="loginPass" type="password" />
      </div>
      <div style="display:flex;gap:8px;justify-content:space-between">
        <div class="small linkish" id="showRegister">Create account</div>
        <button id="doLogin" class="deposit-btn">Login</button>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">Save password to browser is optional (use browser prompt).</div>
    </div>

    <div id="registerForm" style="display:none">
      <div class="form-row">
        <label>Full name</label>
        <input id="regName" placeholder="Your name" />
      </div>
      <div class="form-row">
        <label>Phone number</label>
        <input id="regPhone" placeholder="07XXXXXXXX" />
      </div>
      <div class="row-h">
        <div style="flex:1" class="form-row">
          <label>Password</label>
          <input id="regPass" type="password" />
        </div>
        <div style="flex:1" class="form-row">
          <label>Confirm</label>
          <input id="regPass2" type="password" />
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:space-between">
        <div class="small linkish" id="showLogin">Already have account?</div>
        <button id="doRegister" class="deposit-btn">Create</button>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">New accounts start with 1000 balance.</div>
    </div>
  </div>
</div>

<script>
(() => {
  const PRE_ROUND = 5_000;  
  const FLIGHT = 5_000;     
  const CYCLE = PRE_ROUND + FLIGHT; 
  const DEFAULT_BALANCE = 1000;
  const MULTIPLIERS = [1.27,2.14,1.03,3.82,7.41,1.56,1.11,4.27,12.49,1.24,2.71,1.09,8.35,1.63,1.02,5.42,2.03,1.18,3.54,10.83,
    1.15,1.07,6.48,2.32,1.95,1.04,1.34,9.64,1.13,3.09,1.26,4.91,2.67,1.08,1.52,1.21,14.72,1.03,2.18,1.09,
    1.88,3.47,1.06,7.22,1.24,1.11,2.97,5.84,1.04,18.93,1.27,1.18,4.48,1.06,2.54,1.77,8.92,1.39,1.08,3.63,
    1.14,1.04,22.41,1.57,2.01,1.07,4.12,6.83,1.09,1.28,3.96,2.38,1.05,1.16,15.74,1.23,1.02,9.83,2.91,1.31,
    1.18,4.34,1.47,1.06,13.56,1.09,2.26,1.04,6.37,3.04,1.07,1.12,5.78,2.79,1.03,1.61,12.84,1.05,4.53,1.07,
    1.32,6.92,1.14,1.03,24.61,1.19,2.47,1.08,3.26,1.51,1.11,11.77,1.09,1.04,4.16,2.94,1.07,1.15,7.41,3.84,
    1.05,1.32,10.34,1.29,2.11,1.04,4.07,1.62,1.06,18.47,1.13,1.07,5.59,3.17,1.05,1.26,8.92,1.03,1.18,12.33,
    1.21,1.09,4.67,2.61,1.06,1.03,6.44,1.88,1.05,1.17,14.85,1.04,2.36,1.06,3.77,1.58,1.07,16.23,1.31,1.03,
    7.29,2.41,1.09,1.12,5.42,3.98,1.07,1.23,9.14,1.05,1.04,11.81,1.32,1.14,4.84,2.33,1.06,1.03,7.62,4.91,
    1.08,1.17,12.47,1.03,3.72,1.26,2.05,1.04,1.14,25.93,1.36,1.07,4.53,3.64,1.05,1.12,6.21,1.09,1.04,8.71,
    1.26,1.05,5.32,2.47,1.07,1.11,14.31,1.03,1.07,10.57,1.19,1.14,4.91,3.53,1.04,1.26,9.07,1.03,1.18,13.24,
    1.39,1.06,4.62,2.83,1.07,1.03,6.97,1.92,1.05,1.21,18.61,1.06,3.22,1.15,2.41,1.05,1.08,11.39,1.12,1.03,
    8.51,1.28,1.04,4.17,3.11,1.06,1.18,7.73,1.04,1.29];
  const TOTAL = MULTIPLIERS.length;
  const key_accounts = 'avi_accounts';
  const key_session = 'avi_session';
  const key_past = 'avi_past';

  function loadAccounts(){ try { return JSON.parse(localStorage.getItem(key_accounts) || '{}') } catch(e){return {}}}
  function saveAccounts(obj){ localStorage.setItem(key_accounts, JSON.stringify(obj)) }
  function setSession(phone){ localStorage.setItem(key_session, phone) }
  function clearSession(){ localStorage.removeItem(key_session) }
  function getSession(){ return localStorage.getItem(key_session) }
  function loadPast(){ try { return JSON.parse(localStorage.getItem(key_past) || '[]') } catch(e){return []}}
  function savePast(arr){ localStorage.setItem(key_past, JSON.stringify(arr.slice(0,100))) }

  const app = document.getElementById('app');
  const loading = document.getElementById('loading');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authOverlay = document.getElementById('authOverlay');
  const authTitle = document.getElementById('authTitle');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');
  const doLogin = document.getElementById('doLogin');
  const doRegister = document.getElementById('doRegister');
  const closeAuth = document.getElementById('closeAuth');
  const sessionName = document.getElementById('sessionName');
  const userNameTxt = document.getElementById('userNameTxt');
  const balanceBox = document.getElementById('balanceBox');
  const stakeInput = document.getElementById('stakeInput');
  const betButton = document.getElementById('betButton');
  const betAmount = document.getElementById('betAmount');
  const statusBox = document.getElementById('statusBox');
  const genIndex = document.getElementById('genIndex');
  const liveMultiplierEl = document.getElementById('liveMultiplier');
  const roundTimer = document.getElementById('roundTimer');
  const pastList = document.getElementById('pastList');
  const withdrawBtn = document.getElementById('withdrawBtn');
  const depositBtn = document.getElementById('depositBtn');
  const maxBtn = document.getElementById('maxBtn');
  const plus10 = document.getElementById('plus10');
  const plus50 = document.getElementById('plus50');
  const roundStateMsg = document.getElementById('roundStateMsg');

  let accounts = loadAccounts();
  let past = loadPast();
  let currentUser = getSession();
  let userObj = currentUser ? accounts[currentUser] : null;

  let queuedBet = null;
  let activeBet = null;

  function now(){ return Date.now() }
  function formatNumber(n){ return Number(n).toFixed(2) }
  function safeNum(v){ return Math.max(0, Number(v) || 0) }

  function ensureAccount(phone){
    accounts = loadAccounts();
    if(!accounts[phone]){
      accounts[phone] = { name: phone, phone, pass: '', balance: DEFAULT_BALANCE };
      saveAccounts(accounts);
    }
    return accounts[phone];
  }

  function getRoundIndexForTime(t){
    const idx = Math.floor(t / CYCLE) % TOTAL;
    return idx;
  }

  function getCurrentRoundInfo(){
    const t = now();
    const cycleIndex = Math.floor(t / CYCLE);
    const roundIndex = cycleIndex % TOTAL;
    const cycleStart = cycleIndex * CYCLE;
    const elapsed = t - cycleStart;
    const phase = (elapsed < PRE_ROUND) ? 'pre' : 'flight';
    const phaseElapsed = (phase === 'pre') ? elapsed : (elapsed - PRE_ROUND);
    const phaseRemaining = (phase === 'pre') ? (PRE_ROUND - elapsed) : 0; // flight countdown hidden
    const generated = MULTIPLIERS[roundIndex];
    return {
      roundIndex,
      generated,
      phase,
      phaseElapsed,
      phaseRemaining,
      elapsed,
      cycleStart
    };
  }

  function pushPast(mult){
    past.unshift(Number(mult));
    if(past.length>50) past.length=50;
    savePast(past);
    renderPast();
  }
  function renderPast(){
    pastList.innerHTML = '';
    for(let i=0;i<Math.min(10,past.length);i++){
      const v = past[i];
      const el = document.createElement('div');
      el.className='past-item';
      el.textContent = 'Ã—' + formatNumber(v);
      pastList.appendChild(el);
    }
  }

  function refreshSession(){
    currentUser = getSession();
    userObj = currentUser ? (accounts[currentUser]) : null;
    if(userObj){
      sessionName.style.display='inline-block';
      userNameTxt.textContent = userObj.name || userObj.phone;
      loginBtn.style.display='none';
      logoutBtn.style.display='inline-block';
      balanceBox.textContent = String(userObj.balance);
    } else {
      sessionName.style.display='none';
      loginBtn.style.display='inline-block';
      logoutBtn.style.display='none';
      balanceBox.textContent = '1000';
    }
  }

  loginBtn.addEventListener('click', ()=>{ openAuth('login') });
  closeAuth.addEventListener('click', ()=>{ closeAuthOverlay() });
  logoutBtn.addEventListener('click', ()=>{
    clearSession();
