<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#111;
    --accent:#00b04f;
    --muted:#888;
    --yellow:#f0c000;
    --red:#d9534f;
  }
  body{ margin:0; font-family:sans-serif; background:var(--bg); color:#fff; }
  #app{ display:none; flex-direction:column; align-items:center; padding:10px; }
  .bet-button{ padding:10px 20px; margin:5px; cursor:pointer; }
  .bet-button.bet{ background:var(--accent); color:#000; }
  .bet-button.yellow{ background:var(--yellow); color:#000; }
  .bet-button.cancel{ background:var(--red); color:#fff; }
  #authOverlay{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  #authOverlay div{ background:#222; padding:20px; border-radius:5px; }
  input{ padding:5px; margin:3px; }
  #pastList{ display:flex; flex-wrap:wrap; justify-content:center; margin:5px; }
  .past-item{ margin:2px 4px; background:#222; padding:3px 6px; border-radius:3px; }
</style>
</head>
<body>
<div id="loading">Loading...</div>
<div id="app">
  <div>
    <span id="sessionName"></span>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
  <div>
    Balance: <span id="balanceBox">0</span>
  </div>
  <div>
    Stake: <input type="number" id="stakeInput" value="10" min="1">
    <button id="plus10">+10</button>
    <button id="plus50">+50</button>
    <button id="maxBtn">Max</button>
  </div>
  <div>
    <button id="betButton" class="bet-button bet">Bet</button>
    Current Bet: <span id="betAmount">0</span>
  </div>
  <div>
    <div id="roundStateMsg">Betting — place stake</div>
    <div>Next round in: <span id="roundTimer">0s</span></div>
    <div>Live Multiplier: <span id="liveMultiplier">×1.00</span></div>
  </div>
  <div id="pastList"></div>
  <div>
    <button id="withdrawBtn">Withdraw</button>
    <button id="depositBtn">Deposit</button>
  </div>
  <div id="statusBox"></div>
</div>

<div id="authOverlay">
  <div>
    <h3 id="authTitle">Login</h3>
    <div id="loginForm">
      Phone: <input id="loginPhone"><br>
      Password: <input id="loginPass" type="password"><br>
      <button id="doLogin">Login</button>
      <a href="#" id="showRegister">Create account</a>
    </div>
    <div id="registerForm" style="display:none;">
      Name: <input id="regName"><br>
      Phone: <input id="regPhone"><br>
      Password: <input id="regPass" type="password"><br>
      Confirm: <input id="regPass2" type="password"><br>
      <button id="doRegister">Register</button>
      <a href="#" id="showLogin">Login</a>
    </div>
    <button id="closeAuth">Close</button>
  </div>
</div>

<script>
(() => {
const DEFAULT_BALANCE = 1000;
const CYCLE = 10000; // 10s per round
const PRE_ROUND = 5000; // 5s betting
const FLIGHT = 5000; // flight duration
const TOTAL = 250;
const MULTIPLIERS = Array.from({length:TOTAL},()=>1+Math.random()*5);

// ********** STORAGE HELPERS **********
const key_accounts = 'avi_accounts';
const key_session = 'avi_session';
const key_past = 'avi_past';
function loadAccounts(){ try { return JSON.parse(localStorage.getItem(key_accounts) || '{}') } catch(e){return {}}}
function saveAccounts(obj){ localStorage.setItem(key_accounts, JSON.stringify(obj)) }
function setSession(phone){ localStorage.setItem(key_session, phone) }
function clearSession(){ localStorage.removeItem(key_session) }
function getSession(){ return localStorage.getItem(key_session) }
function loadPast(){ try { return JSON.parse(localStorage.getItem(key_past) || '[]') } catch(e){return []}}
function savePast(arr){ localStorage.setItem(key_past, JSON.stringify(arr.slice(0,100))) }

// ********** DOM **********
const app = document.getElementById('app');
const loading = document.getElementById('loading');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authOverlay = document.getElementById('authOverlay');
const authTitle = document.getElementById('authTitle');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const showRegister = document.getElementById('showRegister');
const showLogin = document.getElementById('showLogin');
const doLogin = document.getElementById('doLogin');
const doRegister = document.getElementById('doRegister');
const closeAuth = document.getElementById('closeAuth');
const sessionName = document.getElementById('sessionName');
const userNameTxt = document.getElementById('userNameTxt');
const balanceBox = document.getElementById('balanceBox');
const stakeInput = document.getElementById('stakeInput');
const betButton = document.getElementById('betButton');
const betAmount = document.getElementById('betAmount');
const statusBox = document.getElementById('statusBox');
const genIndex = document.getElementById('genIndex');
const liveMultiplierEl = document.getElementById('liveMultiplier');
const roundTimer = document.getElementById('roundTimer');
const pastList = document.getElementById('pastList');
const withdrawBtn = document.getElementById('withdrawBtn');
const depositBtn = document.getElementById('depositBtn');
const maxBtn = document.getElementById('maxBtn');
const plus10 = document.getElementById('plus10');
const plus50 = document.getElementById('plus50');

// auth fields
const loginPhone = document.getElementById('loginPhone');
const loginPass = document.getElementById('loginPass');
const regName = document.getElementById('regName');
const regPhone = document.getElementById('regPhone');
const regPass = document.getElementById('regPass');
const regPass2 = document.getElementById('regPass2');
const showRegisterLink = showRegister;
const showLoginLink = showLogin;

// ********** APP STATE **********
let accounts = loadAccounts();
let past = loadPast();
let currentUser = getSession();
let userObj = currentUser ? accounts[currentUser] : null;
let queuedBet = null;
let activeBet = null;

// ********** UTIL **********
function now(){ return Date.now() }
function formatNumber(n){ return Number(n).toFixed(2) }
function safeNum(v){ return Math.max(0, Number(v) || 0) }
function ensureAccount(phone){
  accounts = loadAccounts();
  if(!accounts[phone]){
    accounts[phone] = { name: phone, phone, pass: '', balance: DEFAULT_BALANCE };
    saveAccounts(accounts);
  }
  return accounts[phone];
}

// ********** ROUND / MULTIPLIER **********
function getRoundIndexForTime(t){
  const idx = Math.floor(t / CYCLE) % TOTAL;
  return idx;
}
function getCurrentRoundInfo(){
  const t = now();
  const cycleIndex = Math.floor(t / CYCLE);
  const roundIndex = cycleIndex % TOTAL;
  const cycleStart = cycleIndex * CYCLE;
  const elapsed = t - cycleStart;
  const phase = (elapsed < PRE_ROUND) ? 'pre' : 'flight';
  const phaseElapsed = (phase==='pre')? elapsed : (elapsed-PRE_ROUND);
  const phaseRemaining = (phase==='pre')? (PRE_ROUND - elapsed) : (CYCLE - elapsed);
  const generated = MULTIPLIERS[roundIndex];
  return { roundIndex, generated, phase, phaseElapsed, phaseRemaining, elapsed, cycleStart };
}
function getLiveMultiplier(phase, phaseElapsed, generated){
  if(phase!=='flight') return 1.00;
  const t = Math.max(0, Math.min(phaseElapsed, FLIGHT));
  const ratio = t / FLIGHT;
  return 1 + (generated-1)*ratio;
}

// ********** PAST LIST **********
function pushPast(mult){ past.unshift(Number(mult)); if(past.length>50) past.length=50; savePast(past); renderPast(); }
function renderPast(){ pastList.innerHTML=''; for(let i=0;i<Math.min(10,past.length);i++){ const v=past[i]; const el=document.createElement('div'); el.className='past-item'; el.textContent='×'+formatNumber(v); pastList.appendChild(el); } }

// ********** UI / SESSION **********
function refreshSession(){
  currentUser = getSession();
  userObj = currentUser ? accounts[currentUser] : null;
  if(userObj){
    sessionName.style.display='inline-block';
    sessionName.textContent = userObj.name || userObj.phone;
    loginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    balanceBox.textContent = String(userObj.balance);
  } else {
    sessionName.style.display='none';
    loginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
    balanceBox.textContent = String(DEFAULT_BALANCE);
  }
}

// ********** AUTH HANDLERS **********
loginBtn.addEventListener('click', ()=>{ openAuth('login') });
closeAuth.addEventListener('click', ()=>{ closeAuthOverlay() });
logoutBtn.addEventListener('click', ()=>{
  clearSession(); queuedBet=null; activeBet=null;
  statusBox.textContent='Logged out';
  refreshSession();
});
showRegisterLink.addEventListener('click', ()=>{ openAuth('register') });
showLoginLink.addEventListener('click', ()=>{ openAuth('login') });
function openAuth(mode='login'){
  authOverlay.style.display='flex';
  if(mode==='login'){ authTitle.textContent='Login'; loginForm.style.display='block'; registerForm.style.display='none'; }
  else{ authTitle.textContent='Create account'; loginForm.style.display='none'; registerForm.style.display='block'; }
}
function closeAuthOverlay(){ authOverlay.style.display='none'; }

doRegister.addEventListener('click', ()=>{
  const name = regName.value.trim() || regPhone.value.trim();
  const phone = regPhone.value.trim();
  const p1 = regPass.value;
  const p2 = regPass2.value;
  if(!phone){ alert('Enter phone'); return; }
  if(!p1 || p1.length<3){ alert('Password too short'); return; }
  if(p1!==p2){ alert('Passwords do not match'); return; }
  accounts = loadAccounts();
  if(accounts[phone]){ alert('Account exists'); return; }
  accounts[phone] = { name, phone, pass:p1, balance:DEFAULT_BALANCE };
  saveAccounts(accounts);
  setSession(phone);
  closeAuthOverlay();
  refreshSession();
});

doLogin.addEventListener('click', ()=>{
  const phone = loginPhone.value.trim();
  const pass = loginPass.value;
  if(!phone || !pass){ alert('Enter phone and password'); return; }
  accounts = loadAccounts();
  const acc = accounts[phone];
  if(!acc){ alert('No account found'); return; }
  if(acc.pass!==pass){ alert('Password incorrect'); return; }
  setSession(phone);
  closeAuthOverlay();
  refreshSession();
});

// ********** BET / STAKE LOGIC **********
function updateBetUI(){
  betAmount.textContent = queuedBet ? queuedBet.amount : (activeBet? activeBet.amount : 0);
  if(activeBet){ betButton.className='bet-button yellow'; betButton.textContent='Cash out'; }
  else if(queuedBet){ betButton.className='bet-button cancel'; betButton.textContent='Cancel'; }
  else{ betButton.className='bet-button bet'; betButton.textContent='Bet'; }
}
function deductForActive(amt){
  accounts = loadAccounts();
  accounts[currentUser].balance = Number(accounts[currentUser].balance) - amt;
  saveAccounts(accounts);
  userObj = accounts[currentUser];
  balanceBox.textContent = String(Math.round(userObj.balance*100)/100);
}

betButton.addEventListener('click', ()=>{
  if(!currentUser){ openAuth('login'); return; }
  const stake = safeNum(stakeInput.value);
  if(betButton.classList.contains('bet')){
    if(stake<=0){ alert('Enter stake'); return; }
    if(stake>userObj.balance){ alert('Stake must be <= balance'); return; }
    queuedBet={ amount: stake };
    statusBox.textContent='Queued for next round. You may cancel before flight starts.';
    updateBetUI();
  } else if(betButton.classList.contains('cancel')){
    queuedBet=null;
    statusBox.textContent='Bet cancelled';
    updateBetUI();
  } else if(betButton.classList.contains('yellow')){
    if(!activeBet) return;
    const ri = activeBet.roundIndex;
    const generated = MULTIPLIERS[ri];
    const info = getCurrentRoundInfo();
    const live = getLiveMultiplier(info.phase, info.phaseElapsed, generated);
    const win = activeBet.amount * live;
    accounts = loadAccounts();
    accounts[currentUser].balance = Number(accounts[currentUser].balance) + win;
    saveAccounts(accounts);
    userObj = accounts[currentUser];
    activeBet=null;
    statusBox.textContent='Cashed out: ×'+formatNumber(live)+' → +'+formatNumber(win);
    balanceBox.textContent=String(Math.round(userObj.balance*100)/100);
    updateBetUI();
  }
});

// ********** MAIN LOOP **********
let lastRoundIndex = null;
function mainTick(){
  const info = getCurrentRoundInfo();
  const idx = info.roundIndex;
  genIndex && (genIndex.textContent = idx+1);
  renderPast();
  if(info.phase==='pre'){
    roundStateMsg.textContent='Betting — place stake';
    roundTimer.textContent=Math.ceil(info.phaseRemaining/1000)+'s';
    liveMultiplierEl.textContent='×1.00';
  } else {
    // Flight countdown removed
    roundStateMsg.textContent='Flight — live';
    liveMultiplierEl.textContent='×'+formatNumber(getLiveMultiplier(info.phase, info.phaseElapsed, info.generated));
  }

  if(lastRoundIndex===null) lastRoundIndex=idx;
  if(idx!==lastRoundIndex){
    const prevGen = MULTIPLIERS[lastRoundIndex];
    pushPast(prevGen);
    activeBet=null;
  }

  if(info.phase==='flight'){
    if(queuedBet && !activeBet){
      activeBet={ amount: queuedBet.amount, roundIndex: idx };
      queuedBet=null;
      if(currentUser){ deductForActive(activeBet.amount); statusBox.textContent='Bet active — good luck'; }
      else{ activeBet=null; statusBox.textContent='No session — bet cancelled'; }
    }
  }

  updateBetUI();
  lastRoundIndex=idx;
}

setInterval(mainTick,120);

// ********** UI ACTIONS **********
withdrawBtn.addEventListener('click', ()=>{ alert('Withdrawal clicked (dummy).'); });
depositBtn.addEventListener('click', ()=>{
  if(!currentUser){ openAuth('login'); return; }
  const amt = Number(prompt('Enter amount to deposit :', '100')) || 0;
  if(amt===0) return;
  accounts = loadAccounts();
  accounts[currentUser].balance = Number(accounts[currentUser].balance) + amt;
  saveAccounts(accounts);
  userObj = accounts[currentUser];
  balanceBox.textContent = String(Math.round(userObj.balance*100)/100);
  statusBox.textContent='Deposited '+amt;
});
maxBtn.addEventListener('click', ()=>{
  if(!currentUser){ openAuth('login'); return; }
  accounts = loadAccounts();
  const bal = accounts[currentUser].balance || DEFAULT_BALANCE;
  stakeInput.value = bal;
});
plus10.addEventListener('click', ()=>{ stakeInput.value = safeNum(stakeInput.value)+10; });
plus50.addEventListener('click', ()=>{ stakeInput.value = safeNum(stakeInput.value)+50; });
stakeInput.addEventListener('input', ()=>{ betAmount.textContent = queuedBet ? queuedBet.amount : (activeBet? activeBet.amount : safeNum(stakeInput.value)); });

// ********** INIT **********
function init(){
  accounts = loadAccounts();
  past = loadPast();
  refreshSession();
  renderPast();
  loading.style.display='none';
  app.style.display='flex';
  updateBetUI();
}
init();

document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    clearSession();
    refreshSession();
    statusBox.textContent='Session cleared while away; please login again.';
  }
});

if(!past || past.length===0){
  for(let i=0;i<6;i++) pushPast(MULTIPLIERS[(TOTAL-1-i+TOTAL)%TOTAL]);
}
setInterval(()=>{ accounts=loadAccounts(); if(currentUser){ userObj=accounts[currentUser]; if(userObj) balanceBox.textContent=String(Math.round(userObj.balance*100)/100); } },2000);

console.log('Aviator demo initialized. Rounds every '+(CYCLE/1000)+'s. Total multipliers:',TOTAL);
})();
</script>
</body>
</html>
